<script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="{{ "/assets/js/jquery.fitvids.js" | prepend: site.baseurl  }}"></script>
<script type="text/javascript" src="{{ "/assets/js/index.js" | prepend: site.baseurl  }}"></script>
<script type="text/javascript" src="{{ "/assets/js/readingTime.min.js" | prepend: site.baseurl  }}"></script>
<script>
(function ($) {
  "use strict";
  $(document).ready(function(){

    var $window = $(window),
    $image = $('.post-image-image, .teaserimage-image');
    
      $window.on('scroll', function() {
        var top = $window.scrollTop();

        if (top < 0 || top > 1500) { return; }
        $image
          .css('transform', 'translate3d(0px, '+top/3+'px, 0px)')
          .css('opacity', 1-Math.max(top/700, 0));
      });
      $window.trigger('scroll');

      var height = $('.article-image').height();
      if (height) {
        $('.post-content').css('padding-top', height + 'px');
      }

      $('a[href*=#]:not([href=#])').click(function() {
        if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'')
         && location.hostname == this.hostname) {
          var target = $(this.hash);
          target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
          if (target.length) {
            $('html,body').animate({ scrollTop: target.offset().top }, 500);
            return false;
          }
        }
      });

  });
}(jQuery));
</script>

<script>
// Image modal functionality
(function ($) {
  "use strict";
  $(document).ready(function(){
    // Create modal structure
    var modalHTML = '<div id="imageModal" class="image-modal">' +
                      '<span class="modal-close">&times;</span>' +
                      '<img class="modal-content" id="modalImage">' +
                    '</div>';
    $('body').append(modalHTML);
    
    var modal = $('#imageModal');
    var modalImg = $('#modalImage');
    var closeBtn = $('.modal-close');
    
    // Open modal on image click (only for images with 'modal' class)
    $('.post-content img.modal').on('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      var imgSrc = $(this).attr('src');
      modalImg.attr('src', imgSrc);
      modal.addClass('active');
      $('body').css('overflow', 'hidden'); // Prevent body scroll
    });
    
    // Close modal on close button click
    closeBtn.on('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      modal.removeClass('active');
      $('body').css('overflow', ''); // Restore body scroll
    });
    
    // Close modal on any click (background, image, or anywhere)
    modal.on('click', function(e) {
      modal.removeClass('active');
      $('body').css('overflow', ''); // Restore body scroll
    });
    
    // Close modal on ESC key
    $(document).on('keydown', function(e) {
      if (e.key === 'Escape' && modal.hasClass('active')) {
        modal.removeClass('active');
        $('body').css('overflow', ''); // Restore body scroll
      }
    });
    
    // Add "Click to enlarge" hint text under modal images
    $('.post-content img.modal, .chart-item img.modal').each(function() {
      // Check if hint already exists to avoid duplicates
      if ($(this).next('.modal-enlarge-hint').length === 0) {
        $(this).after('<span class="modal-enlarge-hint">Click to enlarge</span>');
      }
    });
  });
}(jQuery));
</script>

<script>
// Floating Table of Contents
(function ($) {
  "use strict";
  $(document).ready(function(){
    var $toc = $('#toc-floating');
    var $tocList = $('#toc-list');
    var $progressBar = $('.toc-progress-bar');
    var $postContent = $('.post-content');

    // Find all H1 elements in post content
    var $headings = $postContent.find('h1');

    console.log('TOC: Found ' + $headings.length + ' H1 headings');

    // Only show TOC if there are H1 headings
    if ($headings.length === 0) {
      console.log('TOC: No H1 headings found, not showing TOC');
      return;
    }

    // Build TOC
    $headings.each(function(index) {
      var $heading = $(this);
      var headingId = 'heading-' + index;

      // Add ID to heading if it doesn't have one
      if (!$heading.attr('id')) {
        $heading.attr('id', headingId);
      } else {
        headingId = $heading.attr('id');
      }

      // Add to TOC
      var $li = $('<li><a href="#' + headingId + '">' + $heading.text() + '</a></li>');
      $tocList.append($li);
    });

    console.log('TOC: Built TOC with ' + $tocList.find('li').length + ' items');

    // Show TOC after content starts
    function updateTOC() {
      var scrollTop = $(window).scrollTop();
      var contentTop = $postContent.offset().top - 100;
      var contentBottom = contentTop + $postContent.outerHeight();

      // Show/hide TOC
      if (scrollTop > contentTop && scrollTop < contentBottom) {
        $toc.addClass('visible');
      } else {
        $toc.removeClass('visible');
      }

      // Update active heading and progress
      var activeIndex = -1;
      $headings.each(function(index) {
        var headingTop = $(this).offset().top - 150;
        if (scrollTop >= headingTop) {
          activeIndex = index;
        }
      });

      // Update active link
      $tocList.find('a').removeClass('active');
      if (activeIndex >= 0) {
        $tocList.find('a').eq(activeIndex).addClass('active');
      }

      // Update progress bar
      if ($headings.length > 0) {
        var progress = activeIndex >= 0 ? ((activeIndex + 1) / $headings.length) * 100 : 0;
        $progressBar.css('background', 'linear-gradient(to bottom, #dd9d8f ' + progress + '%, rgba(221, 157, 143, 0.2) ' + progress + '%)');
      }
    }

    // Scroll handler
    $(window).on('scroll', updateTOC);
    updateTOC();

    // Smooth scroll for TOC links
    $tocList.on('click', 'a', function(e) {
      e.preventDefault();
      var target = $(this.getAttribute('href'));
      if (target.length) {
        $('html, body').animate({ scrollTop: target.offset().top - 100 }, 500);
      }
    });
  });
}(jQuery));
</script>
{% if site.google_analytics %}
{% include google_analytics.html %}
{% endif %}
